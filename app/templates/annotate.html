{% extends "layout.html" %}

{% block content %}
<style>
    /* ========== é¡µé¢å¸ƒå±€ - å›ºå®šé«˜åº¦ç­‰é«˜è®¾è®¡ ========== */
    .main-row {
        display: flex;
        gap: 20px;
        height: calc(100vh - 180px);
        min-height: 500px;
    }
    
    .left-panel {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 15px;
        height: 100%;
    }
    
    .right-panel {
        width: 320px;
        flex-shrink: 0;
        height: 100%;
    }
    
    /* ========== å·¦ä¾§å¡ç‰‡ ========== */
    .text-card {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow: hidden;
    }
    
    .text-card .card-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 0;
        min-height: 0;
        overflow: hidden;
    }
    
    .text-ann-card {
        flex-shrink: 0;
    }
    
    /* ========== æ–‡æœ¬å®¹å™¨ - æ»šåŠ¨åŒºåŸŸ ========== */
    #text-container {
        flex: 1;
        padding: 16px 20px;
        line-height: 2.2;
        font-size: 16px;
        letter-spacing: 0.3px;
        overflow-y: auto;
        background: linear-gradient(to bottom, #fafbfc, #f5f6f8);
        border: 1px solid #e8e8e8;
        border-top: none;
        margin: 0 15px;
        min-height: 0;
    }
    
    /* æ»šåŠ¨æ¡ç¾åŒ– */
    #text-container::-webkit-scrollbar,
    #word-list::-webkit-scrollbar {
        width: 8px;
    }
    
    #text-container::-webkit-scrollbar-track,
    #word-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    #text-container::-webkit-scrollbar-thumb,
    #word-list::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }
    
    #text-container::-webkit-scrollbar-thumb:hover,
    #word-list::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
    }
    
    /* ========== è¯æ€§æ ‡æ³¨æ ·å¼ ========== */
    .word-tag {
        display: inline;
        padding: 0 2px;
        margin: 0 1px;
        cursor: pointer;
        transition: all 0.15s;
        border-radius: 2px;
    }
    
    .word-tag:hover {
        filter: brightness(0.92);
    }
    
    .word-tag.selected {
        outline: 2px solid #3B82F6;
        outline-offset: 1px;
        background: #DBEAFE !important;
    }
    
    .word-tag.highlight-flash {
        animation: wordFlash 1.5s ease-out;
    }
    
    /* ä¸´æ—¶é«˜äº®æ¡†æ ·å¼ */
    .word-tag.temp-highlight,
    .entity-tag.temp-highlight {
        outline: 3px solid #F59E0B !important;
        outline-offset: 2px;
        box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
    }
    
    @keyframes wordFlash {
        0%, 30% { 
            background: #FCD34D !important;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
        }
        100% { 
            box-shadow: none;
        }
    }
    
    /* å®è¯ - é¢œè‰²è°ƒæµ… */
    .pos-n { background: rgba(37, 99, 235, 0.35); }
    .pos-v { background: rgba(22, 163, 74, 0.35); }
    .pos-a { background: rgba(234, 88, 12, 0.35); }
    .pos-m { background: rgba(219, 39, 119, 0.35); }
    .pos-q { background: rgba(13, 148, 136, 0.35); }
    .pos-r { background: rgba(79, 70, 229, 0.35); }
    .pos-t { background: rgba(220, 38, 38, 0.35); }
    /* è™šè¯ - é¢œè‰²è°ƒæµ… */
    .pos-d { background: rgba(139, 92, 246, 0.20); }
    .pos-p { background: rgba(100, 116, 139, 0.18); }
    .pos-c { background: rgba(107, 114, 128, 0.15); }
    .pos-u { background: rgba(156, 163, 175, 0.12); }
    .pos-w { background: rgba(209, 213, 219, 0.10); }
    
    /* ========== å®ä½“æ ‡æ³¨æ ·å¼ ========== */
    .entity-tag {
        display: inline;
        border-bottom: 2px solid;
        padding: 0 2px;
        margin: 0 1px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .entity-tag:hover {
        filter: brightness(0.95);
    }
    
    .entity-tag.highlight-flash {
        animation: entityFlash 1.5s ease-out;
    }
    
    @keyframes entityFlash {
        0%, 30% { 
            background: #FCD34D !important;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
        }
        100% { 
            box-shadow: none;
        }
    }
    
    .entity-äººå { border-color: #2563EB; color: #1e40af; background: rgba(37, 99, 235, 0.12); }
    .entity-åœ°å { border-color: #16A34A; color: #166534; background: rgba(22, 163, 74, 0.12); }
    .entity-ç»„ç»‡æœºæ„ { border-color: #EA580C; color: #9a3412; background: rgba(234, 88, 12, 0.12); }
    .entity-æ—¶é—´æ—¥æœŸ { border-color: #7C3AED; color: #5b21b6; background: rgba(124, 58, 237, 0.12); }
    .entity-æ•°å€¼é‡‘é¢ { border-color: #DC2626; color: #991b1b; background: rgba(220, 38, 38, 0.12); }
    
    /* ========== æ¨¡å¼åˆ‡æ¢ ========== */
    .mode-switch {
        display: flex;
        gap: 10px;
        padding: 12px 15px;
        background: #f8f9fa;
        flex-shrink: 0;
    }
    
    .mode-btn {
        flex: 1;
        padding: 12px 20px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
    }
    
    .mode-btn:hover {
        border-color: #3B82F6;
        background: rgba(59, 130, 246, 0.05);
    }
    
    .mode-btn.active {
        border-color: #3B82F6;
        background: #3B82F6;
        color: white;
    }
    
    /* ========== å›¾ä¾‹ ========== */
    .legend-container {
        background: #f8f9fa;
        padding: 12px 15px;
        border: 1px solid #e8e8e8;
        border-top: none;
        margin: 0 15px 15px 15px;
        flex-shrink: 0;
    }
    
    .legend-title {
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 13px;
        color: #555;
    }
    
    .legend-items {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }
    
    .legend-item {
        display: inline-flex;
        align-items: center;
        font-size: 12px;
        background: white;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
    }
    
    .legend-color {
        width: 18px;
        height: 14px;
        border-radius: 2px;
        margin-right: 5px;
        border: 1px solid rgba(0,0,0,0.1);
    }
    
    .legend-n { background: rgba(37, 99, 235, 0.35); }
    .legend-v { background: rgba(22, 163, 74, 0.35); }
    .legend-a { background: rgba(234, 88, 12, 0.35); }
    .legend-m { background: rgba(219, 39, 119, 0.35); }
    .legend-q { background: rgba(13, 148, 136, 0.35); }
    .legend-r { background: rgba(79, 70, 229, 0.35); }
    .legend-t { background: rgba(220, 38, 38, 0.35); }
    .legend-d { background: rgba(139, 92, 246, 0.20); }
    .legend-p { background: rgba(100, 116, 139, 0.18); }
    .legend-c { background: rgba(107, 114, 128, 0.15); }
    .legend-u { background: rgba(156, 163, 175, 0.12); }
    .legend-w { background: rgba(209, 213, 219, 0.10); }
    
    /* å›¾ä¾‹é¢œè‰² - å®ä½“ */
    .legend-äººå { background: rgba(37, 99, 235, 0.4); }
    .legend-åœ°å { background: rgba(22, 163, 74, 0.4); }
    .legend-ç»„ç»‡æœºæ„ { background: rgba(234, 88, 12, 0.4); }
    .legend-æ—¶é—´æ—¥æœŸ { background: rgba(124, 58, 237, 0.4); }
    .legend-æ•°å€¼é‡‘é¢ { background: rgba(220, 38, 38, 0.4); }
    
    /* ========== å³ä¾§åˆ—è¡¨ - ç­‰é«˜ ========== */
    .word-list-card {
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .word-list-card .card-header {
        flex-shrink: 0;
        padding: 12px 15px;
    }
    
    .word-list-card .card-body {
        flex: 1;
        overflow-y: auto;
        padding: 0;
        min-height: 0;
    }
    
    /* ========== è¯è¯­åˆ—è¡¨æ ·å¼ ========== */
    .word-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
        cursor: pointer;
    }
    
    .word-item:hover {
        background: #f0f7ff;
    }
    
    .word-item:last-child {
        border-bottom: none;
    }
    
    .word-item.highlight {
        background: #FEF3C7;
        animation: highlight-fade 2s ease-out forwards;
    }
    
    @keyframes highlight-fade {
        0% { background: #FCD34D; }
        100% { background: white; }
    }
    
    /* å·¦ä¾§ï¼šè¯è¯­æ–‡æœ¬ */
    .word-text {
        font-weight: 600;
        font-size: 15px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
        min-width: 0;
    }
    
    /* å³ä¾§ï¼šæ ‡ç­¾+æŒ‰é’® */
    .word-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
        margin-left: 12px;
    }
    
    /* è¯æ€§åˆ—è¡¨æ ‡ç­¾ - å®è¯æ·±è‰² */
    .word-pos {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 4px;
        color: white;
        font-weight: 500;
        white-space: nowrap;
    }
    
    .pos-badge-n { background: #2563EB; }
    .pos-badge-v { background: #16A34A; }
    .pos-badge-a { background: #EA580C; }
    .pos-badge-m { background: #DB2777; }
    .pos-badge-q { background: #0D9488; }
    .pos-badge-r { background: #4F46E5; }
    .pos-badge-t { background: #DC2626; }
    
    /* è¯æ€§åˆ—è¡¨æ ‡ç­¾ - è™šè¯æµ…è‰² */
    .pos-badge-d { background: #A78BFA; }
    .pos-badge-p { background: #94A3B8; }
    .pos-badge-c { background: #9CA3AF; }
    .pos-badge-u { background: #D1D5DB; color: #555; }
    .pos-badge-w { background: #E5E7EB; color: #666; }
    
    /* å®ä½“åˆ—è¡¨æ ‡ç­¾ */
    .word-entity {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 4px;
        color: white;
        font-weight: 500;
        white-space: nowrap;
    }
    
    .entity-badge-äººå { background: #2563EB; }
    .entity-badge-åœ°å { background: #16A34A; }
    .entity-badge-ç»„ç»‡æœºæ„ { background: #EA580C; }
    .entity-badge-æ—¶é—´æ—¥æœŸ { background: #7C3AED; }
    .entity-badge-æ•°å€¼é‡‘é¢ { background: #DC2626; }
    
    /* ç¼–è¾‘æŒ‰é’® */
    .btn-edit-item {
        width: 26px;
        height: 26px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        color: #666;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    
    .btn-edit-item:hover {
        background: #3B82F6;
        border-color: #3B82F6;
        color: white;
    }
    
    /* ========== ç©ºçŠ¶æ€æç¤º ========== */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        min-height: 200px;
        color: #999;
        padding: 40px;
    }
    
    .empty-state i {
        font-size: 3rem;
        opacity: 0.3;
        margin-bottom: 1rem;
    }
    
    /* ========== ç¼–è¾‘å·¥å…·æ  ========== */
    .edit-toolbar {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #1E293B;
        padding: 12px 24px;
        border-radius: 12px;
        display: none;
        gap: 12px;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 1000;
    }
    
    .edit-toolbar.show {
        display: flex;
    }
    
    .edit-toolbar button {
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-merge { background: #10B981; }
    .btn-cancel { background: #6B7280; }
    
    /* ========== æç¤ºä¿¡æ¯ ========== */
    .edit-hint {
        background: #EFF6FF;
        padding: 10px 15px;
        font-size: 13px;
        color: #1E40AF;
        border-left: 4px solid #3B82F6;
        margin: 0 15px;
        flex-shrink: 0;
    }
    
    /* ========== æ¨¡æ€æ¡† ========== */
    .modal-header {
        background: linear-gradient(135deg, #3B82F6, #60A5FA);
        color: white;
    }
    
    .pos-btn-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
    }
    
    .pos-btn-small {
        padding: 8px;
        font-size: 13px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
    }
    
    .pos-btn-small:hover {
        border-color: #3B82F6;
        background: #EFF6FF;
    }
    
    .pos-btn-small.active {
        border-color: #3B82F6;
        background: #3B82F6;
        color: white;
    }
    
    /* ========== æ–‡æœ¬é€‰æ‹©ï¼ˆå®ä½“æ¨¡å¼ï¼‰ ========== */
    .entity-mode #text-container {
        user-select: text;
        cursor: text;
    }
    
    .entity-mode .entity-tag {
        cursor: pointer;
    }
    
    .segment-mode #text-container {
        user-select: none;
    }
    
    /* ========== Toast ========== */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }
    
    .custom-toast {
        padding: 12px 20px;
        margin-bottom: 10px;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    }
    
    .custom-toast.success { background: #10B981; }
    .custom-toast.error { background: #EF4444; }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2><i class="bi bi-file-text-fill text-primary me-2"></i> {{ file.filename }}</h2>
            <p class="text-muted mb-0">æ–‡æœ¬æ ‡æ³¨ç³»ç»Ÿ</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-primary" onclick="smartAnnotate()">
                <i class="bi bi-magic me-1"></i> æ™ºèƒ½æ ‡æ³¨
            </button>
            <button class="btn btn-warning" onclick="clearAllAnnotations()">
                <i class="bi bi-eraser me-1"></i> æ¸…ç©ºæ ‡æ³¨
            </button>
            <button class="btn btn-success" onclick="saveAllAnnotations()">
                <i class="bi bi-save me-1"></i> ä¿å­˜æ ‡æ³¨
            </button>
            <a href="/" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> è¿”å›
            </a>
        </div>
    </div>
</div>

<div class="row main-row">
    <div class="col-lg-9 left-panel">
        <!-- æ–‡æœ¬å†…å®¹å¡ç‰‡ -->
        <div class="card text-card">
            <div class="card-header bg-white py-2">
                <h6 class="mb-0"><i class="bi bi-text-paragraph text-primary me-2"></i>æ–‡æœ¬å†…å®¹</h6>
            </div>
            <div class="card-body">
                <div class="mode-switch">
                    <button class="mode-btn active" data-mode="segment" onclick="switchMode('segment')">
                        <i class="bi bi-scissors"></i> åˆ†è¯å’Œè¯æ€§æ ‡æ³¨
                    </button>
                    <button class="mode-btn" data-mode="entity" onclick="switchMode('entity')">
                        <i class="bi bi-tags"></i> å‘½åå®ä½“æ ‡æ³¨
                    </button>
                </div>
                <div class="edit-hint" id="mode-hint">
                    <strong>åˆ†è¯æ¨¡å¼ï¼š</strong>å•å‡»è¯è¯­å¯ç¼–è¾‘å¹¶å®šä½ | Ctrl+å•å‡»é€‰æ‹©å¤šä¸ªè¯è¿›è¡Œåˆå¹¶
                </div>
                <div id="text-container" class="segment-mode"></div>
                <div class="legend-container" id="legend-container">
                    <div class="legend-title" id="legend-title">ğŸ“ è¯æ€§é¢œè‰²è¯´æ˜ï¼ˆå®è¯æ·±è‰² Â· è™šè¯æµ…è‰²ï¼‰</div>
                    <div class="legend-items" id="legend-items"></div>
                </div>
            </div>
        </div>
        
        <!-- æ–‡æœ¬æ•´ä½“æ ‡æ³¨å¡ç‰‡ -->
        <div class="card text-ann-card">
            <div class="card-header bg-white py-2">
                <h6 class="mb-0"><i class="bi bi-tags text-primary me-2"></i>æ–‡æœ¬æ•´ä½“æ ‡æ³¨</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">æ–‡æœ¬åˆ†ç±»</label>
                        <select class="form-select" id="text-category">
                            <option value="">-- é€‰æ‹©åˆ†ç±» --</option>
                            <option value="æ–°é—»æ—¶äº‹">ğŸ“° æ–°é—»æ—¶äº‹</option>
                            <option value="ç§‘æŠ€æ•°ç ">ğŸ’» ç§‘æŠ€æ•°ç </option>
                            <option value="è´¢ç»é‡‘è">ğŸ’° è´¢ç»é‡‘è</option>
                            <option value="ä½“è‚²è¿åŠ¨">ğŸ€ ä½“è‚²è¿åŠ¨</option>
                            <option value="å¨±ä¹å½±è§†">ğŸ¬ å¨±ä¹å½±è§†</option>
                            <option value="æ•™è‚²å­¦æœ¯">ğŸ“š æ•™è‚²å­¦æœ¯</option>
                            <option value="æ³•å¾‹æ³•è§„">âš–ï¸ æ³•å¾‹æ³•è§„</option>
                            <option value="åŒ»ç–—å¥åº·">ğŸ¥ åŒ»ç–—å¥åº·</option>
                            <option value="ç”Ÿæ´»æœåŠ¡">ğŸ  ç”Ÿæ´»æœåŠ¡</option>
                            <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">æ–‡æœ¬æƒ…æ„Ÿ</label>
                        <select class="form-select" id="text-sentiment">
                            <option value="">-- é€‰æ‹©æƒ…æ„Ÿ --</option>
                            <option value="ç§¯æ">ğŸ˜Š ç§¯æ</option>
                            <option value="ä¸­æ€§">ğŸ˜ ä¸­æ€§</option>
                            <option value="æ¶ˆæ">ğŸ˜” æ¶ˆæ</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å³ä¾§è¯è¯­åˆ—è¡¨ -->
    <div class="col-lg-3 right-panel">
        <div class="card word-list-card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0" id="word-list-title"><i class="bi bi-list-ul text-primary me-2"></i>è¯è¯­åˆ—è¡¨</h6>
                <span class="badge bg-primary" id="word-count">0</span>
            </div>
            <div class="card-body" id="word-list">
                <div class="empty-state">
                    <i class="bi bi-info-circle"></i>
                    <p>ç‚¹å‡»"æ™ºèƒ½æ ‡æ³¨"å¼€å§‹</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è¯æ€§ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal fade" id="posModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title mb-0"><i class="bi bi-pencil-square me-2"></i>ç¼–è¾‘è¯æ€§</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <input type="hidden" id="current-word-id">
                <p class="text-center mb-3">
                    å½“å‰è¯è¯­ï¼š<strong id="current-word-text" class="text-primary fs-5"></strong>
                </p>
                <div class="pos-btn-grid" id="pos-btn-grid"></div>
            </div>
        </div>
    </div>
</div>

<!-- å®ä½“ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal fade" id="entityModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2" style="background: linear-gradient(135deg, #10B981, #34D399);">
                <h6 class="modal-title mb-0"><i class="bi bi-tag-fill me-2"></i>ç¼–è¾‘å®ä½“</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <input type="hidden" id="entity-id">
                <p class="text-center mb-3">
                    å½“å‰å®ä½“ï¼š<strong id="entity-text" class="text-primary fs-5"></strong>
                </p>
                <div class="d-grid gap-2">
                    <button class="btn btn-sm text-white" style="background: #2563EB;" onclick="updateEntity('äººå')">ğŸ‘¤ äººå</button>
                    <button class="btn btn-sm text-white" style="background: #16A34A;" onclick="updateEntity('åœ°å')">ğŸ“ åœ°å</button>
                    <button class="btn btn-sm text-white" style="background: #EA580C;" onclick="updateEntity('ç»„ç»‡æœºæ„')">ğŸ¢ ç»„ç»‡æœºæ„</button>
                    <button class="btn btn-sm text-white" style="background: #7C3AED;" onclick="updateEntity('æ—¶é—´æ—¥æœŸ')">ğŸ“… æ—¶é—´æ—¥æœŸ</button>
                    <button class="btn btn-sm text-white" style="background: #DC2626;" onclick="updateEntity('æ•°å€¼é‡‘é¢')">ğŸ’² æ•°å€¼é‡‘é¢</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteEntity()"><i class="bi bi-x-circle me-1"></i>åˆ é™¤å®ä½“</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢å®ä½“æ¨¡æ€æ¡† -->
<div class="modal fade" id="addEntityModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2" style="background: linear-gradient(135deg, #10B981, #34D399);">
                <h6 class="modal-title mb-0"><i class="bi bi-plus-circle me-2"></i>æ·»åŠ å®ä½“</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <input type="hidden" id="new-entity-start">
                <input type="hidden" id="new-entity-end">
                <p class="text-center mb-3">
                    é€‰ä¸­æ–‡æœ¬ï¼š<strong id="new-entity-text" class="text-primary fs-5"></strong>
                </p>
                <div class="d-grid gap-2">
                    <button class="btn btn-sm text-white" style="background: #2563EB;" onclick="addEntity('äººå')">ğŸ‘¤ äººå</button>
                    <button class="btn btn-sm text-white" style="background: #16A34A;" onclick="addEntity('åœ°å')">ğŸ“ åœ°å</button>
                    <button class="btn btn-sm text-white" style="background: #EA580C;" onclick="addEntity('ç»„ç»‡æœºæ„')">ğŸ¢ ç»„ç»‡æœºæ„</button>
                    <button class="btn btn-sm text-white" style="background: #7C3AED;" onclick="addEntity('æ—¶é—´æ—¥æœŸ')">ğŸ“… æ—¶é—´æ—¥æœŸ</button>
                    <button class="btn btn-sm text-white" style="background: #DC2626;" onclick="addEntity('æ•°å€¼é‡‘é¢')">ğŸ’² æ•°å€¼é‡‘é¢</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="edit-toolbar" id="editToolbar">
    <span style="color: white;" id="selectedCount">å·²é€‰æ‹© 0 ä¸ªè¯</span>
    <button class="btn-merge" onclick="mergeSelected()"><i class="bi bi-union me-1"></i> åˆå¹¶</button>
    <button class="btn-cancel" onclick="clearSelection()"><i class="bi bi-x-lg me-1"></i> å–æ¶ˆ</button>
</div>

<div class="toast-container" id="toastContainer"></div>

<script id="file-data" type="application/json">
{
    "fileId": {{ file.id }},
    "rawText": {{ file.content | tojson }},
    "textAnn": {
        "category": {{ (text_ann.text_category if text_ann else "") | tojson }},
        "sentiment": {{ (text_ann.text_sentiment if text_ann else "") | tojson }}
    },
    "wordAnns": {{ word_anns | tojson }},
    "entityAnns": {{ entity_anns | tojson }}
}
</script>

<script>
// ========== æ•°æ®åˆå§‹åŒ– ==========
const fileData = JSON.parse(document.getElementById('file-data').textContent);
const fileId = fileData.fileId;
const rawText = fileData.rawText;
let wordAnnotations = fileData.wordAnns || [];
let entityAnnotations = fileData.entityAnns || [];
let currentMode = 'segment';
let selectedWords = [];
let currentHighlightedElement = null; // ç”¨äºè·Ÿè¸ªå½“å‰é«˜äº®çš„å…ƒç´ 

// è¯æ€§å®šä¹‰
const posTypes = [
    {code: 'n', name: 'åè¯', type: 'å®è¯'},
    {code: 'v', name: 'åŠ¨è¯', type: 'å®è¯'},
    {code: 'a', name: 'å½¢å®¹è¯', type: 'å®è¯'},
    {code: 'm', name: 'æ•°è¯', type: 'å®è¯'},
    {code: 'q', name: 'é‡è¯', type: 'å®è¯'},
    {code: 'r', name: 'ä»£è¯', type: 'å®è¯'},
    {code: 't', name: 'æ—¶é—´è¯', type: 'å®è¯'},
    {code: 'd', name: 'å‰¯è¯', type: 'è™šè¯'},
    {code: 'p', name: 'ä»‹è¯', type: 'è™šè¯'},
    {code: 'c', name: 'è¿è¯', type: 'è™šè¯'},
    {code: 'u', name: 'åŠ©è¯', type: 'è™šè¯'},
    {code: 'w', name: 'æ ‡ç‚¹', type: 'è™šè¯'}
];

const entityTypes = [
    {label: 'äººå'},
    {label: 'åœ°å'},
    {label: 'ç»„ç»‡æœºæ„'},
    {label: 'æ—¶é—´æ—¥æœŸ'},
    {label: 'æ•°å€¼é‡‘é¢'}
];

let posModal, entityModal, addEntityModal;

document.addEventListener('DOMContentLoaded', function() {
    posModal = new bootstrap.Modal(document.getElementById('posModal'));
    entityModal = new bootstrap.Modal(document.getElementById('entityModal'));
    addEntityModal = new bootstrap.Modal(document.getElementById('addEntityModal'));
    
    const grid = document.getElementById('pos-btn-grid');
    grid.innerHTML = posTypes.map(p => 
        `<button class="pos-btn-small" data-pos="${p.code}" onclick="selectPos('${p.code}', '${p.name}')">${p.name}</button>`
    ).join('');
    
    if (fileData.textAnn.category) {
        document.getElementById('text-category').value = fileData.textAnn.category;
    }
    if (fileData.textAnn.sentiment) {
        document.getElementById('text-sentiment').value = fileData.textAnn.sentiment;
    }
    
    document.getElementById('text-container').addEventListener('mouseup', handleTextSelection);
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶æ¸…é™¤ä¸´æ—¶é«˜äº®
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.word-item') && !e.target.closest('.word-tag') && !e.target.closest('.entity-tag')) {
            clearTempHighlight();
        }
    });
    
    renderAll();
    updateLegend();
});

// æ¸…é™¤ä¸´æ—¶é«˜äº®
function clearTempHighlight() {
    if (currentHighlightedElement) {
        currentHighlightedElement.classList.remove('temp-highlight');
        currentHighlightedElement = null;
    }
    // ä¹Ÿæ¸…é™¤æ‰€æœ‰å…¶ä»–å¯èƒ½çš„é«˜äº®
    document.querySelectorAll('.temp-highlight').forEach(el => el.classList.remove('temp-highlight'));
}

function switchMode(mode) {
    currentMode = mode;
    const container = document.getElementById('text-container');
    
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
    });
    
    const hint = document.getElementById('mode-hint');
    if (mode === 'segment') {
        hint.innerHTML = '<strong>åˆ†è¯æ¨¡å¼ï¼š</strong>å•å‡»è¯è¯­å¯ç¼–è¾‘å¹¶å®šä½ | Ctrl+å•å‡»é€‰æ‹©å¤šä¸ªè¯è¿›è¡Œåˆå¹¶';
        container.classList.remove('entity-mode');
        container.classList.add('segment-mode');
        document.getElementById('word-list-title').innerHTML = '<i class="bi bi-list-ul text-primary me-2"></i>è¯è¯­åˆ—è¡¨';
    } else {
        hint.innerHTML = '<strong>å®ä½“æ¨¡å¼ï¼š</strong>é€‰ä¸­æ–‡æœ¬æ·»åŠ å®ä½“ | å•å‡»å®ä½“å¯ç¼–è¾‘å¹¶å®šä½';
        container.classList.remove('segment-mode');
        container.classList.add('entity-mode');
        document.getElementById('word-list-title').innerHTML = '<i class="bi bi-tags text-primary me-2"></i>å®ä½“åˆ—è¡¨';
    }
    
    clearSelection();
    clearTempHighlight();
    renderAll();
    updateLegend();
}

function updateLegend() {
    const title = document.getElementById('legend-title');
    const items = document.getElementById('legend-items');
    
    if (currentMode === 'segment') {
        title.innerHTML = 'ğŸ“ è¯æ€§é¢œè‰²è¯´æ˜ï¼ˆå®è¯æ·±è‰² Â· è™šè¯æµ…è‰²ï¼‰';
        const shiCi = posTypes.filter(p => p.type === 'å®è¯');
        const xuCi = posTypes.filter(p => p.type === 'è™šè¯');
        items.innerHTML = `
            ${shiCi.map(p => `<span class="legend-item"><span class="legend-color legend-${p.code}"></span>${p.name}</span>`).join('')}
            <span class="legend-item" style="background: #f0f0f0; border: none; padding: 4px 6px;">|</span>
            ${xuCi.map(p => `<span class="legend-item"><span class="legend-color legend-${p.code}"></span>${p.name}</span>`).join('')}
        `;
    } else {
        title.innerHTML = 'ğŸ·ï¸ å®ä½“ç±»å‹è¯´æ˜';
        items.innerHTML = entityTypes.map(e => `
            <span class="legend-item"><span class="legend-color legend-${e.label}"></span>${e.label}</span>
        `).join('');
    }
}

function renderAll() {
    if (currentMode === 'segment') {
        renderSegmentMode();
        updateWordList(wordAnnotations);
    } else {
        renderEntityMode();
        updateWordList(entityAnnotations);
    }
}

function displayRawText() {
    document.getElementById('text-container').innerHTML = `<p>${escapeHtml(rawText)}</p>`;
}

function renderSegmentMode() {
    const container = document.getElementById('text-container');
    
    if (!wordAnnotations || wordAnnotations.length === 0) {
        // ä¿æŒä¸€è‡´ï¼Œä½¿ç”¨ escapeHtml
        container.innerHTML = `<p>${escapeHtml(rawText)}</p>`;
        return;
    }
    
    let html = '';
    wordAnnotations.forEach(w => {
        const posClass = 'pos-' + (w.pos || 'n');
        html += `<span class="word-tag ${posClass}" data-id="${w.id}" 
                    onclick="handleWordClick(event, ${w.id})">${escapeHtml(w.word)}</span>`;
    });
    
    container.innerHTML = html;
}

function renderEntityMode() {
    const container = document.getElementById('text-container');
    
    if (!entityAnnotations || entityAnnotations.length === 0) {
        // æ²¡æœ‰å®ä½“æ—¶ï¼Œæ•´ä¸ªæ–‡æœ¬ä½œä¸ºä¸€ä¸ªå¸¦ä½ç½®æ ‡è®°çš„ span
        container.innerHTML = `<span class="plain-text" data-start="0" data-end="${rawText.length}">${escapeHtml(rawText)}</span>`;
        return;
    }
    
    const sorted = [...entityAnnotations].sort((a, b) => a.start_pos - b.start_pos);
    
    let html = '';
    let lastEnd = 0;
    
    sorted.forEach(entity => {
        if (entity.start_pos > lastEnd) {
            // æ™®é€šæ–‡æœ¬æ®µï¼Œæ·»åŠ ä½ç½®æ ‡è®°
            const text = rawText.substring(lastEnd, entity.start_pos);
            html += `<span class="plain-text" data-start="${lastEnd}" data-end="${entity.start_pos}">${escapeHtml(text)}</span>`;
        }
        // å®ä½“æ ‡ç­¾ä¹Ÿæ·»åŠ ä½ç½®æ ‡è®°
        html += `<span class="entity-tag entity-${entity.label}" data-entity-id="${entity.id}" 
                    data-start="${entity.start_pos}" data-end="${entity.end_pos}"
                    onclick="handleEntityClick(event, ${entity.id})">${escapeHtml(entity.text)}</span>`;
        lastEnd = entity.end_pos;
    });
    
    if (lastEnd < rawText.length) {
        const text = rawText.substring(lastEnd);
        html += `<span class="plain-text" data-start="${lastEnd}" data-end="${rawText.length}">${escapeHtml(text)}</span>`;
    }
    
    container.innerHTML = html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function updateWordList(items) {
    const listContainer = document.getElementById('word-list');
    const countBadge = document.getElementById('word-count');
    
    if (!items || items.length === 0) {
        countBadge.textContent = '0';
        listContainer.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-info-circle"></i>
                <p>${currentMode === 'segment' ? 'æš‚æ— åˆ†è¯ç»“æœ' : 'æš‚æ— å®ä½“æ ‡æ³¨'}</p>
            </div>
        `;
        return;
    }
    
    countBadge.textContent = items.length;
    
    if (currentMode === 'segment') {
        listContainer.innerHTML = items.map(w => `
            <div class="word-item" data-id="${w.id}" onclick="handleListItemClick(event, 'word', ${w.id})">
                <span class="word-text">${w.word}</span>
                <div class="word-actions">
                    <span class="word-pos pos-badge-${w.pos}">${w.pos_cn}</span>
                    <button class="btn-edit-item" onclick="handleEditButtonClick(event, 'word', ${w.id})" title="ç¼–è¾‘è¯æ€§">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
            </div>
        `).join('');
    } else {
        listContainer.innerHTML = items.map(e => `
            <div class="word-item" data-entity-id="${e.id}" onclick="handleListItemClick(event, 'entity', ${e.id})">
                <span class="word-text">${e.text}</span>
                <div class="word-actions">
                    <span class="word-entity entity-badge-${e.label}">${e.label}</span>
                    <button class="btn-edit-item" onclick="handleEditButtonClick(event, 'entity', ${e.id})" title="ç¼–è¾‘å®ä½“">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
}

// ========== å•å‡»å®šä½ + ç¼–è¾‘åŠŸèƒ½ ==========

// æ–‡æœ¬åŒºåŸŸç‚¹å‡»ï¼šå®šä½åˆ°åˆ—è¡¨ + æ‰“å¼€ç¼–è¾‘
function handleWordClick(event, wordId) {
    if (currentMode !== 'segment') return;
    
    event.stopPropagation();
    
    if (event.ctrlKey || event.metaKey) {
        // Ctrl+ç‚¹å‡»ï¼šé€‰æ‹©åˆå¹¶
        toggleWordSelection(wordId);
    } else {
        // æ™®é€šç‚¹å‡»ï¼šå®šä½åˆ—è¡¨ + æ‰“å¼€ç¼–è¾‘
        if (selectedWords.length > 0) {
            clearSelection();
        }
        scrollToListItem('word', wordId);
        editWordPos(wordId);
    }
}

function handleEntityClick(event, entityId) {
    event.stopPropagation();
    // å®šä½åˆ—è¡¨ + æ‰“å¼€ç¼–è¾‘
    scrollToListItem('entity', entityId);
    editEntity(entityId);
}

// åˆ—è¡¨é¡¹ç‚¹å‡»ï¼ˆéç¼–è¾‘æŒ‰é’®ï¼‰ï¼šåªå®šä½é«˜äº®ï¼Œä¸æ‰“å¼€ç¼–è¾‘æ¡†
function handleListItemClick(event, type, id) {
    // å¦‚æœç‚¹å‡»çš„æ˜¯ç¼–è¾‘æŒ‰é’®ï¼Œä¸å¤„ç†ï¼ˆç”±handleEditButtonClickå¤„ç†ï¼‰
    if (event.target.closest('.btn-edit-item')) {
        return;
    }
    
    event.stopPropagation();
    
    // æ»šåŠ¨åˆ°æ–‡æœ¬ä¸­çš„å…ƒç´ å¹¶æ·»åŠ ä¸´æ—¶é«˜äº®æ¡†
    scrollToTextItemWithTempHighlight(type, id);
    
    // é«˜äº®åˆ—è¡¨é¡¹
    const listContainer = document.getElementById('word-list');
    let selector = type === 'word' 
        ? `.word-item[data-id="${id}"]` 
        : `.word-item[data-entity-id="${id}"]`;
    const listItem = listContainer.querySelector(selector);
    if (listItem) {
        highlightListItem(listItem);
    }
}

// ç¼–è¾‘æŒ‰é’®ç‚¹å‡»ï¼šå®šä½ + æ‰“å¼€ç¼–è¾‘æ¡†
function handleEditButtonClick(event, type, id) {
    event.stopPropagation();
    
    scrollToTextItem(type, id);
    
    if (type === 'word') {
        editWordPos(id);
    } else {
        editEntity(id);
    }
}

// æ»šåŠ¨åˆ°åˆ—è¡¨é¡¹å¹¶é«˜äº®
function scrollToListItem(type, id) {
    const listContainer = document.getElementById('word-list');
    let selector = type === 'word' 
        ? `.word-item[data-id="${id}"]` 
        : `.word-item[data-entity-id="${id}"]`;
    
    const listItem = listContainer.querySelector(selector);
    if (listItem) {
        listItem.scrollIntoView({behavior: 'smooth', block: 'center'});
        highlightListItem(listItem);
    }
}

// æ»šåŠ¨åˆ°æ–‡æœ¬ä¸­çš„å…ƒç´ å¹¶é«˜äº®ï¼ˆç”¨äºç¼–è¾‘æŒ‰é’®ç‚¹å‡»ï¼‰
function scrollToTextItem(type, id) {
    const textContainer = document.getElementById('text-container');
    let selector = type === 'word' 
        ? `.word-tag[data-id="${id}"]` 
        : `.entity-tag[data-entity-id="${id}"]`;
    
    const element = textContainer.querySelector(selector);
    if (element) {
        element.scrollIntoView({behavior: 'smooth', block: 'center'});
        
        // ç§»é™¤ä¹‹å‰çš„é«˜äº®
        document.querySelectorAll('.highlight-flash').forEach(el => el.classList.remove('highlight-flash'));
        
        // æ·»åŠ é«˜äº®åŠ¨ç”»
        element.classList.add('highlight-flash');
    }
}

// æ»šåŠ¨åˆ°æ–‡æœ¬ä¸­çš„å…ƒç´ å¹¶æ·»åŠ ä¸´æ—¶é«˜äº®æ¡†ï¼ˆç”¨äºåˆ—è¡¨é¡¹ç‚¹å‡»ï¼‰
function scrollToTextItemWithTempHighlight(type, id) {
    const textContainer = document.getElementById('text-container');
    let selector = type === 'word' 
        ? `.word-tag[data-id="${id}"]` 
        : `.entity-tag[data-entity-id="${id}"]`;
    
    const element = textContainer.querySelector(selector);
    if (element) {
        element.scrollIntoView({behavior: 'smooth', block: 'center'});
        
        // æ¸…é™¤ä¹‹å‰çš„ä¸´æ—¶é«˜äº®
        clearTempHighlight();
        
        // æ·»åŠ ä¸´æ—¶é«˜äº®æ¡†
        element.classList.add('temp-highlight');
        currentHighlightedElement = element;
    }
}

function highlightListItem(item) {
    // ç§»é™¤æ‰€æœ‰é«˜äº®
    document.querySelectorAll('.word-item.highlight').forEach(el => el.classList.remove('highlight'));
    // æ·»åŠ é«˜äº®
    item.classList.add('highlight');
}

// ========== åˆ†è¯é€‰æ‹©åˆå¹¶ ==========
function toggleWordSelection(wordId) {
    const index = selectedWords.indexOf(wordId);
    const element = document.querySelector(`.word-tag[data-id="${wordId}"]`);
    
    if (index > -1) {
        selectedWords.splice(index, 1);
        element.classList.remove('selected');
    } else {
        selectedWords.push(wordId);
        element.classList.add('selected');
    }
    
    updateEditToolbar();
}

function updateEditToolbar() {
    const toolbar = document.getElementById('editToolbar');
    const countSpan = document.getElementById('selectedCount');
    
    if (selectedWords.length > 0) {
        toolbar.classList.add('show');
        countSpan.textContent = `å·²é€‰æ‹© ${selectedWords.length} ä¸ªè¯`;
    } else {
        toolbar.classList.remove('show');
    }
}

function clearSelection() {
    selectedWords.forEach(id => {
        const element = document.querySelector(`.word-tag[data-id="${id}"]`);
        if (element) element.classList.remove('selected');
    });
    selectedWords = [];
    updateEditToolbar();
}

function mergeSelected() {
    if (selectedWords.length < 2) {
        showToast('è¯·è‡³å°‘é€‰æ‹©2ä¸ªè¯', 'error');
        return;
    }
    
    fetch('/api/merge_words', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            word_ids: selectedWords,
            words_data: wordAnnotations
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(data.message, 'success');
            clearSelection();
            
            if (data.word_annotations) {
                wordAnnotations = data.word_annotations;
                renderAll();
            }
        } else {
            showToast(data.message || 'åˆå¹¶å¤±è´¥', 'error');
        }
    })
    .catch(err => {
        showToast('åˆå¹¶å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
}

// ========== è¯æ€§ç¼–è¾‘ ==========
function editWordPos(wordId) {
    const word = wordAnnotations.find(w => w.id === wordId);
    if (!word) return;
    
    document.getElementById('current-word-id').value = wordId;
    document.getElementById('current-word-text').textContent = word.word;
    
    document.querySelectorAll('.pos-btn-small').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.pos === word.pos);
    });
    
    posModal.show();
}

function selectPos(pos, posName) {
    const wordId = document.getElementById('current-word-id').value;
    
    fetch('/api/update_word_pos', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({id: wordId, pos: pos, pos_cn: posName})
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            const word = wordAnnotations.find(w => w.id == wordId);
            if (word) {
                word.pos = pos;
                word.pos_cn = posName;
            }
            renderAll();
            posModal.hide();
            showToast('è¯æ€§å·²æ›´æ–°', 'success');
        }
    });
}

// ========== å®ä½“æ¨¡å¼æ–‡æœ¬é€‰æ‹© ==========
function handleTextSelection(e) {
    if (currentMode !== 'entity') return;
    if (e.target.classList.contains('entity-tag')) return;
    
    const selection = window.getSelection();
    const selectedText = selection.toString().trim();
    
    if (selectedText.length === 0) return;
    
    const range = selection.getRangeAt(0);
    
    // æ‰¾åˆ°é€‰åŒºèµ·å§‹æ‰€åœ¨çš„ span å…ƒç´ 
    let startNode = range.startContainer;
    let startSpan = (startNode.nodeType === Node.TEXT_NODE) ? startNode.parentElement : startNode;
    
    // æ‰¾åˆ°é€‰åŒºç»“æŸæ‰€åœ¨çš„ span å…ƒç´ 
    let endNode = range.endContainer;
    let endSpan = (endNode.nodeType === Node.TEXT_NODE) ? endNode.parentElement : endNode;
    
    // æ£€æŸ¥æ˜¯å¦åœ¨æ™®é€šæ–‡æœ¬åŒºåŸŸé€‰æ‹©
    if (!startSpan.classList.contains('plain-text')) {
        showToast('è¯·åœ¨æ™®é€šæ–‡æœ¬åŒºåŸŸé€‰æ‹©', 'error');
        selection.removeAllRanges();
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦è·¨è¶Šäº†å¤šä¸ª spanï¼ˆå¯èƒ½è·¨è¶Šäº†å®ä½“ï¼‰
    if (startSpan !== endSpan) {
        // æ£€æŸ¥æ˜¯å¦è·¨è¶Šäº†å®ä½“
        if (!endSpan.classList.contains('plain-text')) {
            showToast('ä¸èƒ½è·¨è¶Šå·²æœ‰å®ä½“è¿›è¡Œé€‰æ‹©', 'error');
            selection.removeAllRanges();
            return;
        }
        // è·¨è¶Šå¤šä¸ªæ™®é€šæ–‡æœ¬æ®µï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
        // ç®€åŒ–å¤„ç†ï¼šä½¿ç”¨èµ·å§‹ span çš„ä½ç½® + é€‰ä¸­æ–‡æœ¬é•¿åº¦
    }
    
    // è·å– span åœ¨åŸæ–‡ä¸­çš„èµ·å§‹ä½ç½®
    const spanRawStart = parseInt(startSpan.dataset.start);
    
    // è·å–é€‰åŒºåœ¨æ–‡æœ¬èŠ‚ç‚¹ä¸­çš„èµ·å§‹åç§»
    const offsetInNode = range.startOffset;
    
    // è®¡ç®—åœ¨åŸæ–‡ä¸­çš„å®é™…ä½ç½®
    let startPos = spanRawStart + offsetInNode;
    let endPos = startPos + selectedText.length;
    
    // éªŒè¯è®¡ç®—æ˜¯å¦æ­£ç¡®
    const verifyText = rawText.substring(startPos, endPos);
    if (verifyText !== selectedText) {
        console.warn('ä½ç½®è®¡ç®—æœ‰åå·®ï¼Œå°è¯•ä¿®æ­£', {selectedText, verifyText, startPos});
        
        // å›é€€æ–¹æ¡ˆï¼šä»è®¡ç®—å‡ºçš„è¿‘ä¼¼ä½ç½®é™„è¿‘æœç´¢
        const searchStart = Math.max(0, spanRawStart);
        const searchEnd = Math.min(rawText.length, parseInt(startSpan.dataset.end) + 50);
        const searchArea = rawText.substring(searchStart, searchEnd);
        const relativePos = searchArea.indexOf(selectedText, offsetInNode > 10 ? offsetInNode - 10 : 0);
        
        if (relativePos !== -1) {
            startPos = searchStart + relativePos;
            endPos = startPos + selectedText.length;
        } else {
            showToast('æ— æ³•ç²¾ç¡®å®šä½é€‰ä¸­æ–‡æœ¬', 'error');
            selection.removeAllRanges();
            return;
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦ä¸å·²æœ‰å®ä½“é‡å 
    const overlapping = entityAnnotations.some(e => 
        (startPos < e.end_pos && endPos > e.start_pos)
    );
    
    if (overlapping) {
        showToast('é€‰ä¸­åŒºåŸŸä¸ç°æœ‰å®ä½“é‡å ', 'error');
        selection.removeAllRanges();
        return;
    }
    
    // è®¾ç½®æ¨¡æ€æ¡†æ•°æ®
    document.getElementById('new-entity-text').textContent = selectedText;
    document.getElementById('new-entity-start').value = startPos;
    document.getElementById('new-entity-end').value = endPos;
    
    addEntityModal.show();
    selection.removeAllRanges();
}

function addEntity(label) {
    const text = document.getElementById('new-entity-text').textContent;
    const startPos = parseInt(document.getElementById('new-entity-start').value);
    const endPos = parseInt(document.getElementById('new-entity-end').value);
    
    fetch('/api/add_entity', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            file_id: fileId,
            text: text,
            label: label,
            start_pos: startPos,
            end_pos: endPos,
            is_manual: true
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            entityAnnotations.push(data.entity);
            entityAnnotations.sort((a, b) => a.start_pos - b.start_pos);
            renderAll();
            addEntityModal.hide();
            showToast('å®ä½“å·²æ·»åŠ ', 'success');
        } else {
            showToast(data.message || 'æ·»åŠ å¤±è´¥', 'error');
        }
    });
}

// ========== å®ä½“ç¼–è¾‘ ==========
function editEntity(entityId) {
    const entity = entityAnnotations.find(e => e.id === entityId);
    if (!entity) return;
    
    document.getElementById('entity-id').value = entityId;
    document.getElementById('entity-text').textContent = entity.text;
    
    entityModal.show();
}

function updateEntity(label) {
    const entityId = document.getElementById('entity-id').value;
    
    fetch(`/api/update_entity/${entityId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({label: label})
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            const entity = entityAnnotations.find(e => e.id == entityId);
            if (entity) {
                entity.label = label;
                entity.is_manual = true;
            }
            renderAll();
            entityModal.hide();
            showToast('å®ä½“å·²æ›´æ–°ï¼ˆå°†åŠ å…¥çŸ¥è¯†åº“ï¼‰', 'success');
        }
    });
}

function deleteEntity() {
    const entityId = document.getElementById('entity-id').value;
    
    if (!confirm('ç¡®å®šåˆ é™¤æ­¤å®ä½“ï¼Ÿ')) return;
    
    fetch(`/api/delete_entity/${entityId}`, {method: 'DELETE'})
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            entityAnnotations = entityAnnotations.filter(e => e.id != entityId);
            renderAll();
            entityModal.hide();
            showToast('å®ä½“å·²åˆ é™¤', 'success');
        }
    });
}

// ========== æ™ºèƒ½æ ‡æ³¨ ==========
function smartAnnotate() {
    if (!confirm('æ™ºèƒ½æ ‡æ³¨å°†æ¸…é™¤å½“å‰æ ‡æ³¨ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) return;
    
    showToast('æ­£åœ¨æ™ºèƒ½æ ‡æ³¨...', 'success');
    
    fetch(`/api/smart_annotate/${fileId}`, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            wordAnnotations = data.word_annotations;
            entityAnnotations = data.entity_annotations;
            
            if (data.text_annotation) {
                document.getElementById('text-category').value = data.text_annotation.text_category || '';
                document.getElementById('text-sentiment').value = data.text_annotation.text_sentiment || '';
            }
            
            renderAll();
            showToast('æ™ºèƒ½æ ‡æ³¨å®Œæˆï¼Œè¯·ç‚¹å‡»"ä¿å­˜æ ‡æ³¨"å†™å…¥æ•°æ®åº“', 'success');
        } else {
            showToast(data.message || 'æ™ºèƒ½æ ‡æ³¨å¤±è´¥', 'error');
        }
    })
    .catch(err => {
        showToast('æ™ºèƒ½æ ‡æ³¨å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
}

// ========== ä¿å­˜å’Œæ¸…ç©º ==========
function saveAllAnnotations() {
    const data = {
        file_id: fileId,
        text_category: document.getElementById('text-category').value,
        text_sentiment: document.getElementById('text-sentiment').value,
        word_annotations: wordAnnotations,
        entity_annotations: entityAnnotations
    };
    
    fetch('/api/save_all_annotations', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(`ä¿å­˜æˆåŠŸï¼è¯è¯­${data.saved_words || 0}ä¸ªï¼Œå®ä½“${data.saved_entities || 0}ä¸ª`, 'success');
        } else {
            showToast(data.message || 'ä¿å­˜å¤±è´¥', 'error');
        }
    })
    .catch(err => {
        showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
}

function clearAllAnnotations() {
    if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ ‡æ³¨ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
    
    fetch(`/api/clear_annotations/${fileId}`, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            wordAnnotations = [];
            entityAnnotations = [];
            document.getElementById('text-category').value = '';
            document.getElementById('text-sentiment').value = '';
            displayRawText();
            updateWordList([]);
            showToast('å·²æ¸…ç©ºæ ‡æ³¨', 'success');
        }
    });
}

// ========== Toast æç¤º ==========
function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `custom-toast ${type}`;
    toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'x-circle'} me-2"></i>${message}`;
    container.appendChild(toast);
    
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}