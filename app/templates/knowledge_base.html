{% extends "layout.html" %}

{% block content %}
<style>
    .entity-card { transition: all 0.3s ease; }
    .entity-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
    .entity-text { font-weight: 500; font-size: 1.1rem; }
    .entity-label { font-size: 0.9rem; padding: 4px 12px; border-radius: 20px; color: #fff; }
    .label-äººå { background: #3B82F6; }
    .label-åœ°å { background: #10B981; }
    .label-ç»„ç»‡æœºæ„ { background: #F59E0B; }
    .label-æ—¶é—´æ—¥æœŸ { background: #8B5CF6; }
    .label-æ•°å€¼é‡‘é¢ { background: #EF4444; }
    .search-input { border-radius: 25px; padding-left: 20px; }
    .delete-btn { opacity: 0; transition: opacity 0.3s ease; }
    .entity-card:hover .delete-btn { opacity: 1; }
    .entity-list-container { max-height: 600px; overflow-y: auto; }
</style>

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2><i class="bi bi-database-fill text-primary me-2"></i> çŸ¥è¯†åº“ç®¡ç†</h2>
            <p class="text-muted">ç®¡ç†ç³»ç»Ÿè‡ªå­¦ä¹ çš„å®ä½“çŸ¥è¯†åº“ï¼ˆ5ç§å®ä½“ç±»å‹ï¼‰</p>
        </div>
        <span class="badge bg-primary fs-6 px-3 py-2">å®ä½“æ€»æ•°: <span id="total-count">{{ total }}</span></span>
    </div>
</div>

<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-white"><h6 class="mb-0"><i class="bi bi-plus-circle text-primary me-2"></i>æ·»åŠ å®ä½“</h6></div>
            <div class="card-body">
                <form id="add-entity-form">
                    <div class="mb-3">
                        <label class="form-label">å®ä½“æ–‡æœ¬</label>
                        <input type="text" id="entity-text" class="form-control" placeholder="è¾“å…¥å®ä½“åç§°" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å®ä½“ç±»å‹</label>
                        <select id="entity-label" class="form-select" required>
                            <option value="">-- é€‰æ‹©ç±»å‹ --</option>
                            <option value="äººå">ğŸ‘¤ äººå</option>
                            <option value="åœ°å">ğŸ“ åœ°å</option>
                            <option value="ç»„ç»‡æœºæ„">ğŸ¢ ç»„ç»‡æœºæ„</option>
                            <option value="æ—¶é—´æ—¥æœŸ">ğŸ“… æ—¶é—´æ—¥æœŸ</option>
                            <option value="æ•°å€¼é‡‘é¢">ğŸ’² æ•°å€¼é‡‘é¢</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100"><i class="bi bi-plus-lg me-2"></i>æ·»åŠ åˆ°çŸ¥è¯†åº“</button>
                </form>
            </div>
            <div class="card-footer bg-white">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="exportKnowledgeBase()"><i class="bi bi-download me-2"></i>å¯¼å‡ºçŸ¥è¯†åº“</button>
                    <button class="btn btn-outline-danger btn-sm" onclick="clearKnowledgeBase()"><i class="bi bi-trash me-2"></i>æ¸…ç©ºçŸ¥è¯†åº“</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="bi bi-list-ul text-primary me-2"></i>å®ä½“åˆ—è¡¨</h6>
                    <input type="text" id="entity-search" class="form-control form-control-sm search-input" placeholder="æœç´¢å®ä½“..." style="max-width: 200px;">
                </div>
            </div>
            <div class="card-body p-0 entity-list-container">
                {% if entities and entities|length > 0 %}
                <div class="row g-2 p-3" id="entity-list">
                    {% for entity in entities %}
                    <div class="col-md-6 col-lg-4 entity-item" data-id="{{ entity.id }}" data-text="{{ entity.text|lower }}" data-label="{{ entity.label }}">
                        <div class="card entity-card">
                            <div class="card-body py-2 px-3 d-flex justify-content-between align-items-center">
                                <div style="flex: 1; min-width: 0;">
                                    <div class="entity-text text-truncate" title="{{ entity.text }}">{{ entity.text }}</div>
                                    <span class="entity-label label-{{ entity.label }}">{{ entity.label }}</span>
                                </div>
                                <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deleteEntity({{ entity.id }}, '{{ entity.text }}', this)"><i class="bi bi-x"></i></button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5" id="empty-state">
                    <i class="bi bi-database fs-1 mb-3 opacity-25 d-block"></i>
                    <h5 class="text-muted">çŸ¥è¯†åº“ä¸ºç©º</h5>
                    <p class="text-muted">æ·»åŠ å®ä½“æˆ–è¿›è¡Œæ‰‹åŠ¨æ ‡æ³¨åè‡ªåŠ¨å­¦ä¹ </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // æœç´¢åŠŸèƒ½
    document.getElementById('entity-search').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.entity-item');
        let visibleCount = 0;
        
        items.forEach(item => {
            const text = item.dataset.text;
            const label = item.dataset.label.toLowerCase();
            if (text.includes(searchTerm) || label.includes(searchTerm)) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        document.getElementById('total-count').textContent = visibleCount;
    });
    
    // æ·»åŠ å®ä½“
    document.getElementById('add-entity-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const text = document.getElementById('entity-text').value.trim();
        const label = document.getElementById('entity-label').value;
        
        if (!text || !label) {
            alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
            return;
        }
        
        fetch('/api/knowledge/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ text, label })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert(data.message || 'æ·»åŠ å¤±è´¥');
            }
        })
        .catch(err => {
            alert('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    });
    
    // åˆ é™¤å®ä½“
    function deleteEntity(entityId, text, btn) {
        if (!confirm(`ç¡®å®šåˆ é™¤å®ä½“"${text}"å—ï¼Ÿ`)) return;
        
        btn.disabled = true;
        
        fetch(`/api/knowledge/delete/${entityId}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                const item = btn.closest('.entity-item');
                item.style.transition = 'all 0.3s';
                item.style.opacity = '0';
                setTimeout(() => {
                    item.remove();
                    const remainingItems = document.querySelectorAll('.entity-item').length;
                    document.getElementById('total-count').textContent = remainingItems;
                    
                    if (remainingItems === 0) {
                        document.getElementById('entity-list').innerHTML = `
                            <div class="col-12 text-center py-5 text-muted">
                                <i class="bi bi-database fs-1 mb-3 opacity-25 d-block"></i>
                                <h5 class="text-muted">çŸ¥è¯†åº“ä¸ºç©º</h5>
                                <p class="text-muted">æ·»åŠ å®ä½“æˆ–è¿›è¡Œæ‰‹åŠ¨æ ‡æ³¨åè‡ªåŠ¨å­¦ä¹ </p>
                            </div>
                        `;
                    }
                }, 300);
            } else {
                alert('åˆ é™¤å¤±è´¥');
                btn.disabled = false;
            }
        })
        .catch(err => {
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            btn.disabled = false;
        });
    }
    
    // å¯¼å‡ºçŸ¥è¯†åº“
    function exportKnowledgeBase() {
        window.location.href = '/api/knowledge/export';
    }
    
    // æ¸…ç©ºçŸ¥è¯†åº“
    function clearKnowledgeBase() {
        if (!confirm('ç¡®å®šæ¸…ç©ºæ•´ä¸ªçŸ¥è¯†åº“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
        
        fetch('/api/knowledge/entities')
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success' && data.entities.length > 0) {
                const entityIds = data.entities.map(e => e.id);
                return fetch('/api/knowledge/batch_delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ entity_ids: entityIds })
                });
            }
            throw new Error('çŸ¥è¯†åº“å·²ä¸ºç©º');
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('æ¸…ç©ºå¤±è´¥');
            }
        })
        .catch(err => {
            alert(err.message || 'æ“ä½œå¤±è´¥');
        });
    }
</script>
{% endblock %}